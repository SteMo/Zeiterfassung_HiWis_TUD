<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <style type='text/css'>
			img.modifyImage{
				width: 15px;
			}
		</style>
        <title id='title'>HiwiVerwaltung | Personen</title>
 
        <!-- ** CSS ** -->
        <!-- base library -->
        <link rel="stylesheet" type="text/css" href="extjs/resources/css/ext-all.css" />
 
        <!-- overrides to base library -->
 
 
        <!-- ** Javascript ** -->
        <!-- ExtJS library: all widgets -->
        <script type="text/javascript" src="extjs/bootstrap.js"></script>
 
 
        <!-- overrides to library -->
 
        <!-- extensions -->
 
        <!-- page specific -->
 
        <script type="text/javascript">      
        // Path to the blank image should point to a valid location on your server
        // Diese URL führt ins Nichts, wo kommt denn das Bild her?
		// Wird in app.js sowie in den Dateien in /admin noch mindestens 5x angegeben, das sollte nicht sein.
        Ext.BLANK_IMAGE_URL = 'extjs/resources/images/default/s.gif';
 
        Ext.onReady(function(){
        
          var fbStore = Ext.create('Ext.data.Store', {
              fields: ['name'],
              data : [
                  {"name":"Alle"},
                  {"name":"CMS"},
                  {"name":"NCS"},
                  {"name":"HCE"},
                  {"name":"DKE"}
              ]
          });
          
          var ptStore = Ext.create('Ext.data.Store', {
              fields: ['name'],
              data : [
				  {"name":"Alle"},
                  {"name":"Prof"},
                  {"name":"Mitarbeiter"},
                  {"name":"HiWi"}
              ]
          });
      
          Ext.create('Ext.data.Store', {
              storeId:'dataStore',
              fields:['id', 'name', 'fachgebiet', 'position', 'prof_zuordnung', 'mitarbeiter_zuordnung'],
              data:{'items':[
                  {"id": 1, "name":"Lisa", "fachgebiet":"DKE", "position":"Prof", "prof_zuordnung": -1, "mitarbeiter_zuordnung": -1},
                  {"id": 2, "name":"Bart", "fachgebiet":"NCS", "position":"Prof", "prof_zuordnung": -1, "mitarbeiter_zuordnung": -1},
                  {"id": 3, "name":"Homer", "fachgebiet":"HCE", "position":"Prof", "prof_zuordnung": -1, "mitarbeiter_zuordnung": -1},  
                  {"id": 4, "name":"Dieter", "fachgebiet":"CMS", "position":"Prof", "prof_zuordnung": -1, "mitarbeiter_zuordnung": -1}, 
                  {"id": 5, "name":"Lina", "fachgebiet":"CMS", "position":"Mitarbeiter", "prof_zuordnung": 4, "mitarbeiter_zuordnung": -1}, 
				  {"id": 6, "name":"Tobias", "fachgebiet":"NCS", "position":"Mitarbeiter", "prof_zuordnung": 2, "mitarbeiter_zuordnung": -1},
                  {"id": 7, "name":"Emil", "fachgebiet":"HCE", "position":"Hiwi", "prof_zuordnung": 3, "mitarbeiter_zuordnung": -1}, 
                  {"id": 8, "name":"Siegfried", "fachgebiet":"DKE", "position":"HiWi", "prof_zuordnung": 1, "mitarbeiter_zuordnung": -1}, 
                  {"id": 9, "name":"Mira", "fachgebiet":"NCS", "position":"Hiwi", "prof_zuordnung": -1, "mitarbeiter_zuordnung": 6},                       
                  {"id": 10, "name":"Marge", "fachgebiet":"NCS", "position":"HiWi", "prof_zuordnung": 2, "mitarbeiter_zuordnung": -1},            
                  {"id": 11, "name":"Mr. Burns", "fachgebiet":"CMS", "position":"HiWi", "prof_zuordnung": -1, "mitarbeiter_zuordnung": 5}            					
             ]},
              proxy: {
                  type: 'memory',
                  reader: {
                      type: 'json',
                      root: 'items'
                  }
              }
          });
          
          var getPerson = function(value){
							if (value === -1) {
								return '';
							}
							var dataStore;
							var idx;
							if(Ext.data.StoreManager.lookup('dataStore').isFiltered()) {
								dataStore = Ext.data.StoreManager.lookup('dataStore').snapshot;
								idx = dataStore.findIndexBy(function(o,k) {
										if(k==value) {
											return true;
										}
										return false;
									});
							} else {
								dataStore = dataStore = Ext.data.StoreManager.lookup('dataStore');
								idx = dataStore.findExact("id",value);
							}
							if(idx === -1) {
								return "(404 - id: "+ value + ")";
							}
							return dataStore.getAt(idx).get("name");
						}
                    
        
          Ext.create('Ext.Viewport', {
              layout: {
                  type:'vbox',
                  padding:'5',
                  align:'center',
                  autoWidth: true,
              },              
              items: [{                        
                      xtype: 'panel',
                      title: '',
                      width: 700,
                      
                      flex: 0,  
                      tbar: [
                        { xtype: 'button', text: 'Dashboard' },
                        { xtype: 'button', text: 'Fachgebiete' },
                        { xtype: 'button', text: 'Personen', handler: function() {
							window.location.href = "index.html";
							} },
                        { xtype: 'button', text: 'Verträge', handler: function() {
							window.location.href = "vertraege.html";
							}},
                        { xtype: 'button', text: 'Aufgaben' },
                        { xtype: 'button', text: 'Berichte' }
                      ]                    
              },{
                xtype: 'fieldset',
                id: 'listOfFilters',
                width: 700,
                title: '',
                items: [
                    {
                        xtype: 'combo',
                        fieldLabel: 'Fachbereiche',
                        store: fbStore,
                        anchor: '100%',
                        queryMode: 'local',
                        displayField: 'name',
                        valueField: 'name',
                        listeners:{
							select:{
								fn:function(combo, value) {
									var peoples = Ext.getCmp('listOfPeople');
									var filters = peoples.store.filters;
									
									var otherFilters = filters.filterBy(function(value){
										return value.property!="fachgebiet";
										}); // "Vor"-filtern, da clear auch filters loeschen wuerde
									peoples.store.clearFilter();
									
									otherFilters.eachKey(function (key,item) {
													Ext.getCmp("listOfPeople").store.filter(item.property, item.value);
													//console.log("Filtering by..."+item.property+" for "+item.value);
											})
									
									if(combo.getValue()!="Alle") {
										peoples.store.filter('fachgebiet', combo.getValue());
									}
								}
							}
                        }                      
                    },
                    {
                        xtype: 'combo',
                        fieldLabel: 'Personentypen',
                        store: ptStore,
                        anchor: '100%',
                        queryMode: 'local',
                        displayField: 'name',
                        valueField: 'name',                        
                        xtype: 'combo',
                        listeners:{
							select:{
								fn:function(combo, value) {
									var peoples = Ext.getCmp('listOfPeople');
									var filters = peoples.store.filters;
											
									var otherFilters = filters.filterBy(function(value){
										return value.property!="position";
										}); // "Vor"-filtern, da clear auch filters loeschen wuerde
									peoples.store.clearFilter();
									
									otherFilters.eachKey(function (key,item) {
													Ext.getCmp("listOfPeople").store.filter(item.property, item.value);
													//console.log("Filtering by..."+item.property+" for "+item.value);
											})
									
									if(combo.getValue()!="Alle") {
										peoples.store.filter('position', combo.getValue());
									}
								}
							}
                        } 
                    },
                    {
                        xtype: 'button',
                        text: 'Person hinzufügen',
                        icon: ''
                    } 
                ]
            },{
                xtype: 'grid',
                id: 'listOfPeople',
                width: 700,
                title: '',
                autoHeight: true,
                store: Ext.data.StoreManager.lookup('dataStore'),
                columns: [
                    {
                        xtype: 'gridcolumn',
                        dataIndex: 'name',
                        header: 'Name',
                        sortable: true,
                        width: 100,
                        editor: {
							xtype:'textfield',
							allowBlank:false
						}
                    },
                    {
                        xtype: 'gridcolumn',
                        dataIndex: 'fachgebiet',
                        header: 'Fachgebiet',
                        sortable: true,
                        width: 100,
                        align: 'left',
                        editor: {
							xtype:'textfield',
							allowBlank:false
						}
                    },
                    {
                        xtype: 'gridcolumn',
                        dataIndex: 'position',
                        header: 'Position',
                        sortable: true,
                        width: 100,
                        editor: {
							xtype:'textfield',
							allowBlank:false
						}
                    },
                    {
                        xtype: 'gridcolumn',
                        dataIndex: 'prof_zuordnung',
                        header: 'Zugeordneter Professor',
                        sortable: true,
                        width: 175,
						renderer: getPerson

                    },
                    {
                        xtype: 'gridcolumn',
                        dataIndex: 'mitarbeiter_zuordnung',
                        header: 'Zugeordneter Mitarbeiter',
                        sortable: true,
                        width: 175,
						renderer: getPerson

                    },
                    {
						xtype:'actioncolumn', 
						width:50,
						items: [{
							icon: 'images/edit.png',  // Use a URL in the icon config
							iconCls: 'modifyImage',
							tooltip: 'Edit',
							handler: function(grid, rowIndex, colIndex) {
								var rec = grid.getStore().getAt(rowIndex);
								Ext.create('Ext.window.Window', {
									title: 'Hello',
									height: 200,
									width: 400,
									layout: 'fit',
									items: {  // Let's put an empty grid in just to illustrate fit layout
										xtype: 'grid',
										data: grid.getStore().getAt(rowIndex),
										border: false,
										columns: [{ header: 'Name',
													dataIndex: "name"
												  },{
													header: 'Fachbereich',
													dataIndex: "fachbereich"
												  }],                 // One header just for show. There's no data,
										store: Ext.create('Ext.data.ArrayStore', {}) // A dummy empty data store
									}
								}).show();
							}
						},{
							icon: 'images/delete.png',
							iconCls: 'modifyImage',
							tooltip: 'Delete',
							handler: function(grid, rowIndex, colIndex) {
								var rec = grid.getStore().getAt(rowIndex);
								alert("Terminate " + rec.get('name'));
							}                
						}]
					}],
					selType: 'rowmodel',
					plugins: [
					Ext.create('Ext.grid.plugin.RowEditing', {
						clicksToEdit: 1
					})]	
				}]					
            });
 
        }); //end onReady
        </script>
 
    </head>
    <body>
    </body>
</html>
